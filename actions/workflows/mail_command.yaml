---
vars:
    commands_result: ""
chain:
    -
        name: "parse_address"
        ref: "mail_command.parse_address"
        parameters:
            address: "{{ reply_to }}"
        publish:
            reply_address: "{{ parse_address.result }}"
        on-success: "search_host"
    -
        name: "search_host"
        ref: "st2.kv.get_object"
        parameters:
            key: "config.nodes.{{ node }}"
        on-success: "parse_command"
        on-failure: "search_failed"
    -
        name: "parse_command"
        ref: "mail_command.split_text"
        parameters:
            text: "{{ command_text }}"
        publish:
            commands: "{{ parse_command.result }}"
        on-success: "loop_with_commands"
    -
        name: "loop_with_commands"
        ref: "mail_command.iteration"
        parameters:
            items: "{{commands}}"
        publish:
            commands: "{{ loop_with_commands.result[1] }}"
            cmnd: "{{ loop_with_commands.result[0] }}"
        on-success: "execute_command"
        on-failure: "exit_loop"
    -
        name: "execute_command"
        ref: "core.remote"
        parameters:
            cmd: "{{ cmnd }}"
            hosts: "{{ search_host.result.hostname }}"
            username: "{{ search_host.result.username }}"
            password: "{{ search_host.result.password }}"
        publish:
            commands_result: "{{ commands_result }}result of '{{ cmnd }}':\r\n{{ execute_command.stdout }}\r\n" 
        on-success: "loop_with_commands"
    -
        name: "exit_loop"
        ref: "core.sendmail"
        parameters:
            from: "stackstorm@fixpoint.co.jp"
            to: "{{ reply_address }}"
            subject: "result execution commands @ {{ node }}"
            body: "{{ commands_result }}"
    -
        name: "search_failed"
        ref: "core.sendmail"
        parameters:
            from: "stackstorm@fixpoint.co.jp"
            to: "{{ reply_address }}"
            subject: "failed to search host: {{ node }}"
            body: "{{ node }} is unregistered host"
default: "parse_address"
